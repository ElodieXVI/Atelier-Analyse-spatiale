---
title: "01_Data. Import, filtrage, exploration"
author: "R. Leconte"
date: "05/01/2022"
output: html_document
---

Données:

Structure et distribution des revenus, inégalité des niveaux de vie en 2018. Dispositif Fichier localisé social et fiscal (Filosofi)
Millésime 2018
Echellon communal
https://www.insee.fr/fr/statistiques/5009218 

Table de la composition communale des unités urbaines: https://www.insee.fr/fr/information/4802589

Objectifs: 

- importer les données
- filtrage géographique des données
- exploration des données


```{r pkg_wd}
library(readxl)
library(dplyr)
library(ggplot2)
setwd("/Users/elodie/Dropbox/QESS2/Cartographie/Atelier-Analyse-spatiale")
```

# 1. Préparation des données
## 1.1. Chargement

```{r data}
# Table de la distribution des revenus 
disp <- read.csv("Data/FILO2018_DISP_COM.csv", sep = ";")
# Table des taux de pauvreté
pvr <- read.csv("Data/FILO2018_DISP_Pauvres_COM.csv", sep = ";")
# Table des déciles revenu
dec <- read.csv("Data/FILO2018_TRDECILES_DISP_COM.csv", sep = ";")
# Table de la composition communale des unités urbaines
uu <- read_excel("Data/UU2020_au_01-01-2021.xlsx", sheet = 2, skip = 5)
```


## 1.2. Filtrage géographique (sélection des individus)

```{r data_geofilter}
# Extraction des communes faisant partie de l'UU Paris
uu_avignon <- uu %>%  
  filter(UU2020 == "00754" | CODGEO=="84034")

# Filtrage de la table disp
disp_avignon <- disp %>% 
  filter(CODGEO %in% uu_avignon$CODGEO)

# Filtrage de la table pvr
pvr_avignon <- pvr %>% 
  filter(CODGEO %in% uu_avignon$CODGEO)

# Filtrage de la table dec
dec_avignon <- dec %>% 
  filter(CODGEO %in% uu_avignon$CODGEO)
```


## 1.3. Filtrage social (sélection des variables)

```{r data_socfilter}
# Exemple 1: sélection des variables décrivant les énages monoparentaux
disp_avignon_mono <- disp_avignon %>% 
    select(CODGEO, contains("TYM5"))
# Exemple 2: sélection des variables décrivant l'ensemble des ménages
disp_avignon_ens <- disp_avignon %>% 
  select(1:30)

```

# 2. Exploration statistique et graphique

Quelques fonctions utiles 

```{r explor}
# Contrôler la présence de valeurs manquantes dans une variable par communes ménages monoparentaux
table(is.na(disp_avignon_mono$TYM5D118))

#Pour l'ensemble
table(is.na(disp_avignon_ens$Q118))

# Connaitre le résumé statistique
summary(pvr_avignon$TP6018)

# Observer la distribution d'une variable
ggplot(disp_avignon_ens, aes(x=Q218)) + 
  geom_density()+
  scale_y_continuous(labels = scales::comma)+ # se débarasser de la notation scientifique
  # Habiller le graphique
    ylab("Densité de probabilité")+
  xlab("Revenu disponible médian")+
  ggtitle("Distribution du revenu médian par commune à Avignon") + 
  labs(caption ="Source : Filosofi 2020") +
  theme_bw()

# Boîte à moustache
ggplot(disp_avignon_ens, aes(x = Q218))+
  geom_boxplot()

# Graphique rang-taille
ggplot(disp_avignon_ens, aes(x= reorder(CODGEO, -NBPERS18), y = NBPERS18))+
  geom_point() +
  scale_y_log10("Population communale", labels = scales:: comma)+
  scale_x_discrete("Rang", labels= NULL) + 
  labs(caption = "Source : Filosofi 2020") +
  theme_bw()
```


Pour les fonds de cartes : https://www.data.gouv.fr/fr/datasets/decoupage-administratif-communal-francais-issu-d-openstreetmap/ 

```{r map}
library(mapview)
library(mapsf)
library(tidyverse)

carte_uu <- st_read("Cartographie/communes-20220101-shp/communes-20220101.shp")
carte_uu <- rename(carte_uu, "CODGEO" ="insee")
carte_uu <- left_join(uu_avignon, carte_uu, by="CODGEO")
carte_uu <- st_sf(carte_uu)
mapview::mapview(carte_uu)
```

## Sujet : Les revenus des familles monoparentales
- Comparer les familles monoparentales par rapport aux autres catégories de famille et par rapport à l'ensemble de la population : est-ce qu'il y a plus d'inégalités entre les familles monoparentales qu'entre les autres ?
- Échelle de la commune intéressant quand on est à l'échelle de l'unité urbaine : distribution des familles monoparentales dans la commune centre par rapport à la commune périphérique.

*Variables :* les variables générales : 30 première colonnes, tous les TYMC5. 

- barplot rapport interquartiles dans les communes

Principales villes de l'unité urbaine en nombre d'habitants : Avignon, Carpentras, Orange, Cavaillon, L'isle-sur-la-sorgue.

Principales voies d'accès à l'unité urbaine d'Avignon : aéroport d'Avignon-Provence, TGV d'Avignon, A7 (autoroute du soleil)
Le Rhône.
PNR : au sud de l'unité urbaine : 2 PNR Alpilles et Lubéron.


```{r map2}
carte_uu <- left_join(carte_uu, disp_avignon_ens, by="CODGEO")
carte_uu_mono <- left_join(carte_uu, disp_avignon_ens, by="CODGEO")
carte_uu <- st_sf(carte_uu)
carte_uu_mono <- st_sf(carte_uu_mono)
mf_map(carte_uu, var= "Q218", type = "choro", breaks = "quantile", nbreaks = 4, leg_title = "Revenu médian des familles")


mf_map(carte_uu_mono, var= "Q218", type = "choro", breaks = "quantile", nbreaks = 4)
```
